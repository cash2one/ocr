server {
    listen              8580;
    server_name         ai.baidu.com ai.bdstatic.com;
    #more_set_headers    'Server: Apache';
    set $php_upstream 'unix:/home/web-int/var/php-cgi.sock';
    #set $php_upstream 'unix:/home/web-int/var/hhvm.sock';

#########域名适配模块配置###############
    dna off;
    dna_adapt_path "/home/web-int/webserver/conf/adaption";
    dna_url_adaption "device";
    dna_cookie_adaption "device";

#########OMP支持#######################
    #设置产品线
    set $product ai;
    #设置子系统
    set $subsys bdg;
    if ($http_x_bd_product) {
        #从接入层获取产品线
        set $product $http_x_bd_product;
    }
    if ($http_x_bd_subsys) {
        #从接入层获取子系统
        set $subsys $http_x_bd_subsys;
    }


    underscores_in_headers on;
    logid_name x_bd_logid;

#   防盗链
    if ($host !~ "^((.*\.)?(baidu\.(com|com\.cn|cn)|bdstatic\.com|91\.com|shifen\.com|jomodns\.com)|localhost|\d{1,3}(\.\d{1,3}){3})(:\d+)?$") {
        return 403;
    }

    location ~* /(\.svn|CVS|Entries){
        deny all;
    }

    location ~* /((.*)\.(.*)\/(.*)\.php){
        deny all;
    }

    location ~* /\.(sql|bak|inc|old)$ {
        deny all;
    }

    location ~ ^/(favicon.ico|static|dist|images) {
        root            /home/web-int/webroot;
    }

    location ~ \.php$ {
        root            /home/web-int/webroot;
        fastcgi_pass    $php_upstream;
        fastcgi_index   index.php;
        include         fastcgi.conf;
    }

    location /index/{
        proxy_pass http://127.0.0.1:8581/;
    }

    location /internal {
        proxy_pass http://127.0.0.1:8580/;
    }

    location / {
        root /home/web-int/webroot;
        index index.php;
        fastcgi_pass    $php_upstream;
        include         fastcgi.conf;
        rewrite ^(/)?$ /brain/index.php/home break;
        rewrite ^(/[^\?]*)?((\?.*)?)$ /brain/index.php$1$2 break;
    }
}
