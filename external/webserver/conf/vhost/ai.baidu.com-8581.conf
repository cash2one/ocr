upstream backend {
        server unix:/home/web-ext/var/php-cgi-0.sock;
        server unix:/home/web-ext/var/php-cgi-1.sock;
        }

server {
    listen              8581 default backlog=1024;
    server_name         ai.baidu.com ai.bdstatic.com;
    #more_set_headers    'Server: Apache';
    set $php_upstream 'backend';
    #set $php_upstream 'unix:/home/web-ext/var/php-cgi.sock';
    #set $php_upstream 'unix:/home/web-ext/var/hhvm.sock';
    #error_page 400 403 404 500 501 503 504 505 http://www.baidu.com/search/error.html;
    error_page 400 403 404 500 501 503 504 505 /error;

#########域名适配模块配置###############
    dna off;
    dna_adapt_path "/home/web-ext/webserver/conf/adaption";
    dna_url_adaption "device";
    dna_cookie_adaption "device";

#########OMP支持#######################
    #设置产品线
    set $product bdg;
    #设置子系统
    set $subsys ai;
    if ($http_x_bd_product) {
        #从接入层获取产品线
        set $product $http_x_bd_product;
    }
    if ($http_x_bd_subsys) {
        #从接入层获取子系统
        set $subsys $http_x_bd_subsys;
    }


    underscores_in_headers on;
    logid_name x_bd_logid;

#   防盗链
    if ($host !~ "^((.*\.)?(baidu\.(com|com\.cn|cn)|bdstatic\.com|91\.com|shifen\.com|jomodns\.com)|localhost|\d{1,3}(\.\d{1,3}){3})(:\d+)?$") {
        return 403;
    }

    location ~* /(\.svn|CVS|Entries){
        deny all;
    }

    location ~* /((.*)\.(.*)\/(.*)\.php){
        deny all;
    }

    location ~* /\.(sql|bak|inc|old)$ {
        deny all;
    }

    location ~ ^/(favicon.ico|MP_verify_JmWEeqPKyGCmZ4ra.txt|static|dist|ai_images|activity) {
        add_header Cache-Control max-age=864000;
        root            /home/web-ext/webroot;
    }

    location ~ \.php$ {
        root            /home/web-ext/webroot;
        fastcgi_pass    $php_upstream;
        fastcgi_index   index.php;
        include         fastcgi.conf;
    }

    location /index/ {
        proxy_pass http://127.0.0.1:8581/;
    }

    location /internal/ {
        proxy_pass http://ai.int.baidu.com/;
    }

    location /ai_dist/ {
        proxy_pass http://127.0.0.1:8581/dist/;
    }

    location / {
        root /home/web-ext/webroot;
        index index.php;
        fastcgi_pass    $php_upstream;
        include         fastcgi.conf;
        rewrite ^(/)?$ /brain/index.php/home break;
        rewrite ^(/[^\?]*)?((\?.*)?)$ /brain/index.php$1$2 break;
    }
#    location /nginx-status {
#        stub_status on;
#        access_log off;
#        allow 172.20.0.0/16;
#        allow 172.21.0.0/16;
#        allow 172.22.0.0/16;
#        allow 10.0.0.0/8;
#        #allow 61.135.169.0/24;
#        deny all;
#    }
}
